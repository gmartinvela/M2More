# This Python file is the basic file to create the web services with Tornado
# Author: Gustavo Martin Vela

import tornado.ioloop
import tornado.web
import datetime
import MySQLdb as mdb

#con = mdb.connect('localhost', 'root', '221186', 'DHT11');
#with con:
#    cur = con.cursor()
#    cur.execute("SELECT * FROM log")
#    rows = cur.fetchall()
#    for row in rows:
#        print row

class StatisticsHandler(tornado.web.RequestHandler):
    def get(self):
        now = datetime.datetime.now()
        pretty_now = now.strftime("%d-%m-%Y %H:%M")
        con = mdb.connect('localhost', 'root', '221186', 'DHT11');        
        with con:    
            cur = con.cursor()
            invalid_data = cur.execute("select count(*) from log where data = 0")
            valid_data = cur.execute("select count(*) from log where data = 1")
            self.write("<p>Statistics</p><p>" + str(invalid_data)  + " - " + str(valid_data)  + "</p>")

class MainHandler(tornado.web.RequestHandler):
    def get(self):
        now = datetime.datetime.now()
        pretty_now = now.strftime("%d-%m-%Y %H:%M")
        self.write("<p>RPI Bilbao</p><p>" + pretty_now  + "</p>")

application = tornado.web.Application([
    (r"/", MainHandler),
    (r"/statistics", StatisticsHandler),
])

if __name__ == "__main__":
    application.listen(80)
    tornado.ioloop.IOLoop.instance().start()
